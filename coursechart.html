<!doctype html>
<html>
<head>
    <link rel="stylesheet" href="bootstrap-3.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="xAPI-Dashboard/lib/nv.d3.css">
    <script type="text/javascript" src="jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="bootstrap-3.3.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="xAPI-Dashboard/lib/d3.v3.js" charset="utf-8"></script>
	<script type="text/javascript" src="xAPI-Dashboard/lib/nv.d3.js"></script>
	<script type="text/javascript" src="xAPI-Dashboard/lib/xapiwrapper.min.js"></script>
	<script type="text/javascript" src="xAPI-Dashboard/src/chart.js"></script>
	<script type="text/javascript" src="xAPI-Dashboard/src/dashboard.js"></script>
	<script type="text/javascript" src="xAPI-Dashboard/src/xapicollection.js"></script>
<!--
    <script type="text/javascript" src="xAPI-Dashboard/dist/xapidashboard.min.js"></script>
    <script type="text/javascript" src="xAPI-Dashboard/dist/xapicollection.min.js"></script>
-->
    <script type="text/javascript" src="coursedata.js"></script>
    <script type="text/javascript" src="jobaiddata.js"></script>
    <style type="text/css">
        body
        {
            width: 1500px;
            padding-left: 20px;
        }
        
        svg
        {
            width: 700px;
            height: 400px;
        }
        
        #avgscore,
        #activities
        {
            clear: both;
            float:left;
        }
        
        #users
        {
            width: 1100px;
        }
        
        #actorbar div.nvtooltip { margin-left:700px };
    </style>
</head>
<body>
    <h1>Roses SCORM Course Metrics</h1>
    <div id="users">
        <h4>Learner Info</h4>
        <div id="userdetails"></div>
    </div>
    <div id="userChart">
        <h4></h4>
        <svg></svg>
    </div>
    <div>
    <div id="activities">
    <h4>Activity Attempts</h4>
        <svg></svg>
    </div>
    
    <div id="actorbar">
       <h4></h4>
        <svg></svg>
    </div>
    </div>
<!--
    <div id="avgscore">
    <h4>Average score per test</h4>
        <svg></svg>
    </div>
    <div id="actorscore">
       <h4></h4>
        <svg></svg>
    </div>
-->
    <script type="text/javascript">
        var wrapper = ADL.XAPIWrapper;
        wrapper.changeConfig({endpoint:"https://lrs.adlnet.gov/xapi/"});
        var stmtdash = new ADL.XAPIDashboard();
        var attdash = new ADL.XAPIDashboard();
        
        window.onload = function () {
//            dash.fetchAllStatements({}, fetchDoneCallback);
            stmtdash.addStatements(window.CourseData.statements);
            
            graphUserDetails();
            graphActivityAttempts();
//            graphScores();
        };
        
        /******
         *
         * Charts
         *
         *****/
        
        function graphUserDetails() {
            var data = convertCollToData(new ADL.Collection(CourseData.statements).where('verb.id !="'+ADL.verbs.responded.id+'"').groupBy('actor.mbox'));
            nv.addGraph(function() {
                var chart = nv.models.indentedTree()
                    .tableClass('table table-striped') //for bootstrap styling
                    .columns([
                      {
                        key: 'key',
                        label: 'Learner',
                        showCount: false,
                        width: '80%',
                        type: 'text',
                      },
                      {
                        key: 'score',
                        label: 'Score',
                        width: '10%',
                        type: 'text'
                      },
                      {
                        key: 'attempts',
                        label: 'Attempts',
                        width: '10%',
                        type: 'text'
                      }
                    ])
                    ;

              d3.select('#userdetails')
                .datum(data)
                .call(chart)
                ;

              return chart;
            });
        }
        
        function graphActivityAttempts() {
            
            var activityAttemptsBar = attdash.createBarChart({
                container: '#activities svg',
                process: function (data, event, opts) { 
                    var d = mapProfileData(window.CourseData.activityprofiles.profiles);
                    attdash.data = new ADL.Collection(d).contents;
                    opts.cb(                        
                        d.reduce(function(last, now){ 
                                    var added = false;
                                    for(var i in last) { 
                                        if ( last[i].in == now.actid ){ 
                                             last[i].out += now.attempts.length; 
                                            added = true;
                                        }
                                    } 
                                    if (!added)
                                        last.push({in:now.actid,out:now.attempts.length});
                                    return last; 
                                }, [])//;
                    );
                },
                customize: function (chart) {
                    chart.xAxis.rotateLabels(45);
                    chart.xAxis.tickFormat(function(d){return /[^\/]+$/.exec(d)[0];});
                },
                child: actorBar 
            });
            activityAttemptsBar.draw();
        }
        
        var actorBar = attdash.createBarChart({
                container: "#actorbar svg",
                groupBy: "actor.mbox",
                process: function (data, event, opts) {
                    d3.select('#actorbar h4').text("'" + /[^\/]+$/.exec(event.in)[0] + "' Attempts by Actor");
                    var d = mapProfileData(window.CourseData.activityprofiles.profiles);
                    d = new ADL.Collection(d).where('actid = "' + event.in + '"').contents;
                    opts.cb( d.map(function(node) { return {in: node.user, out: node.attempts.length};}) );
                },
                aggregate: ADL.count(),
                customize: function(c) { 
                    c.xAxis.rotateLabels(45);
                    c.xAxis.tickFormat(function(d,e,f){
                        var coll = new ADL.Collection(CourseData.statements);
                        var contents = coll.where('actor.mbox = "'+ d +'"').contents;
                        return contents[0].actor.name;
                    });
                }
            });
        
        function graphUserChart(mbox) {
            // maybe a new dashboard here
            // what about course activity attempts + job aid attempts
            var coll = new ADL.Collection(CourseData.statements),
                contents = coll.where('actor.mbox = "'+ mbox +'"').contents,
                actorname = contents[0].actor.name;
            contents = getCourseToJobaidAttempts(orderByTimestamp(contents.concat(new ADL.Collection(JAData).where('actor.mbox = "'+ mbox +'"').contents)));

            nv.addGraph(function() {
                var chart = nv.models.multiBarChart()
                            .reduceXTicks(false)
                            .rotateLabels(45)
                            .groupSpacing(0.5)
                            .color(["#ff9896", "#9467bd"]);
                
                chart.xAxis
                    .tickFormat(function(d){return /[^\/]+$/.exec(d)[0];});

                d3.select('#userChart svg')
                    .datum(contents)
                    .transition().duration(500)
                    .call(chart)
                    ;

                nv.utils.windowResize(chart.update);

                return chart;
            });
        }
        
        function graphScores() {
            var avgScoreBar = stmtdash.createBarChart({
                container: "#avgscore svg",
                groupBy: 'object.id',
                pre: function (data, event) {
                    return data.where('verb.id = "' + ADL.verbs.scored.id + '"');
                },
                aggregate: ADL.average('result.score.scaled'),
                customize: function(chart, event) {
                    chart.xAxis.rotateLabels(45);
                    chart.xAxis.tickFormat(function(d){return /[^\/]+$/.exec(d)[0];});
                    chart.yAxis.tickFormat(d3.format(',.5f'));
                },
//                child: actorScoresBar
            });
            
            avgScoreBar.draw();
        }
        
        // doesn't work
//        var actorScoresBar = stmtdash.createBarChart({
//            container: "#actorscore svg",
//            groupBy: "object.id",
//            pre: function(data, event) {
//                d3.select('#actorscore h4').text('Test Average for Student');
//                return data.where('verb.id = "' + ADL.verbs.scored.id + '" and ' +
//                                  'actor.mbox = "' + event.in + '"');
//            },
//            aggregate: ADL.average('result.score.scaled'),
//            customize: function(chart, event) {
//                chart.xAxis.rotateLabels(45);
//                chart.xAxis.tickFormat(function(d){return /[^\/]+$/.exec(d)[0];});
//                chart.yAxis.tickFormat(d3.format(',.5f'));
//            }
//        });
        
        /*****
         *
         * Helper Methods
         *
         *****/
        
        /* takes
        *  { 
              user id: {
                 activity id: {
                     attempts : [ attempt ids ]
                 }
             }
        *
        * and turns it into
            [
              {
                user: user id,
                actid: activity id,
                attempts: [ attempt ids ]
              }, ...
            ]
        */
        function mapProfileData( data ) { 
            var ret = [];
            for (var key in data) {
                
                if (data.hasOwnProperty(key)) {
                    for (var actkey in data[key]) {
                        if (data[key].hasOwnProperty(actkey)) {
                            var ob = {};
                            ob.user = key;
                            ob.actid = actkey;
                            ob.attempts = data[key][actkey]["attempts"];
                            ret.push(ob);
                        }
                        
                    }
                }
                
            }
            return ret;
        }
        
        /*
        + we want
        learner         score     attempts
        - activity 
        -- attempt
        etc
        ++ so collection.groupby actor mbox
        contents: [
            {
                group: actor mbox,
                data: [ actor's statements 
                    {
                        "actor"..
                        "verb" ..
                        "object"..
                    }, (more statements)
                ]
            }, (more actors)
        ]
        
        ++ turned into this:
            [
                {
                    "key": "Roses Course",
                    "values":[
                        {
                            "key": actor name - final results: ,
                            "score": final post test stmt score,
                            "attempts": post test counts,
                            "actor": group (actor mbox),
                            "url": link to user chart
                            "_values" : [
                                {
                                    "key":object.id (or name),
                                    "score": avg of total attempt scores (if test),
                                    "attempts": count of activity.id instances,
                                    "activityid":object.id,?
                                    "_values":[
                                        {
                                            "key":activity attempt id,
                                            "score":activity attempt score,
                                            "attempts": (timestamp)
                                        }, (more attempts)
                                    ]
                                }, (more activities)
                            ]
                        }, (more actors)
                    ]
                }
            ]
        */
        function convertCollToData(coll) {
            var data = [];
            data = coll.contents.map(function(node) {
                // node = {data: [statements for actor], group: actor mbox}
                return {
                    // learner level
                    "key": node.data[0].actor.name || node.group,
                    "score": getLearnerFinalScore(node),
                    "attempts": new ADL.Collection(node.data)
                            .where('object.id = "http://adlnet.gov/courses/roses/posttest"' + 
                                   ' and verb.id = "' + ADL.verbs.terminated.id + '"')
                            .contents.length,
                    "actor": node.group,
                    "url": "javascript: graphUserChart('"+node.group+"')",
                    "_values" : new ADL.Collection(node.data).groupBy('object.id')
                        .contents.map(function(node){
                        // node = {data: [statements for activity], group: activity id}
                        return {
                            // activity level
                            "key": /[^\/]+$/.exec(node.group)[0],
                            "score": getActivityTestScoreAverage(node),
                            "attempts": getActivityScoredOrCompletedArray(node).length,
                            "activityid":node.group,
                            "_values": getActivityScoredOrCompletedArray(node).map(function(node){
                                // node = {statement}
                                return {
                                    // attempt level
                                    "key": node.context.contextActivities.grouping[0].id,
                                    "score": getAttemptScore(node),
                                    "attempts": new Date(node.timestamp).toLocaleString()
                                };
                            })
                        };
                    })
                };
            });
            return [{"key":"Roses Course", "values": data}];
        }
        

        function getCourseToJobaidAttempts(stmts) {
            var actset = ["http://adlnet.gov/jobaid/roses/what",
                          "http://adlnet.gov/jobaid/roses/pruning",
                          "http://adlnet.gov/jobaid/roses/deadheading",
                          "http://adlnet.gov/jobaid/roses/shearing",
                          "http://adlnet.gov/jobaid/roses/hybrids",
                          "http://adlnet.gov/jobaid/roses/styles",
                          "http://adlnet.gov/jobaid/roses/symbolism"],
                course = {key: "course", values: []},
                jobaid = {key: "jobaid", values: []},
//                ret = [],
                activities = new ADL.Collection(stmts).groupBy('object.id').contents
                    .reduce(function(prev, cur, idx, arr){
                        prev[cur.group] = cur.data;
                        return prev;
                    }, {});
            
            for (idx in actset) {
                var actid = actset[idx],
                    cid = actid.replace("/jobaid/","/courses/"),
                    key = /[^\/]+$/.exec(actid)[0];
//                ret.push(
//                    {
//                        key: /[^\/]+$/.exec(actid)[0],
//                        values: [
//                            {x: "course", y: (activities[cid])?activities[cid].length:0},
//                            {x: "job aid", y: (activities[actid])?activities[actid].length:0}
//                        ]
//                    }
//                );
                course.values.push({x: key, y: (activities[cid])?activities[cid].length:0});
                jobaid.values.push({x: key, y: (activities[actid])?activities[actid].length:0});
            }
            
            return [course,jobaid];
//            return ret;
        }
        
        function getLearnerFinalScore(node) {
            var col = new ADL.Collection(node.data).where(
                'object.id = "http://adlnet.gov/courses/roses/posttest"' +
                ' and verb.id="'+ ADL.verbs.scored.id +'"');
            
            if (col.contents.length != 0)
                return (col.contents[0].result.score.scaled != 0) ?
                    d3.format(',.2f')(col.contents[0].result.score.scaled) : "0";
            else
                return "-";
        }
        
        function getActivityTestScoreAverage(node) {
            var col = new ADL.Collection(node.data)
                            .where('verb.id = "'+ADL.verbs.scored.id+'"');
            
            var avgs = col.average('result.score.scaled').contents;
            if (avgs[0].data.length != 0)
                return (avgs[0].average != 0)?d3.format(',.3f')(avgs[0].average) + " (avg)" : "0";
            else
                return "-";
        }
        
        function getActivityScoredOrCompletedArray(node) {
            var scored = new ADL.Collection(node.data).where('verb.id = "'+ADL.verbs.scored.id+'"').contents;
            if (scored.length != 0) return scored;
            
            return new ADL.Collection(node.data).where('verb.id = "'+ADL.verbs.completed.id+'"').contents;
        }
        
        function getAttemptScore(node) {
            if(node.result){
                return (node.result.score.scaled != 0) ? d3.format(',.2f')(node.result.score.scaled) : "0";
            }
            return "-";
        }
        
        function orderByTimestamp(stmts) {
            stmts.sort(function(a,b){
              // Turn your strings into dates, and then subtract them
              // to get a value that is either negative, positive, or zero.
              return new Date(b.timestamp) - new Date(a.timestamp);
            });
            return stmts;
        }
    </script>
</body>
</html>